<!DOCTYPE html>
<html>

<head>
<title></title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="http://localhost:8001/socket.io.js"></script>
<script src="http://localhost:8001/qimessaging.js"></script>
</head>

<body>
<canvas id="myCanvas" width="578" height="400"></canvas>
<script language="JavaScript">
var qim = new QiSession("http://localhost:8002");
var m = 0;
var s = "";

qim.socket().on('connect', function() { console.log('connected') })

var t = [];
for (var i = 0; i < 1024; ++i)
{
  t[String.fromCharCode(i)] = i;
}

function getImageRemote(data)
{
  var a = atob(data[6]);

  var canvas = document.getElementById('myCanvas');
  var context = canvas.getContext('2d');
  var imageWidth = data[0];
  var imageHeight = data[1];
  var imageData = context.getImageData(0, 0, imageWidth, imageHeight);
  var data = imageData.data;
  var w = imageWidth * imageHeight * 4;

  var x = 0;
  var x3 = 0;
  while (x < w)
  {
    data[x++] = t[a[x3++]];
    data[x++] = t[a[x3++]];
    data[x++] = t[a[x3++]];
    data[x++] = 255;
  }

  context.putImageData(imageData, 0, 0);

  m.getImageRemote(s).done(getImageRemote);
}

function subscribed(data)
{
  s = data;
  m.getImageRemote(s).done(getImageRemote);
}

function subscribeCamera(data)
{
  m = data;
  var z = Math.floor((Math.random()*10000)+1);
  m.subscribeCamera("test_z" + z, 0, 0, 11, 30).done(subscribed);
}

qim.service("ALVideoDevice").done(subscribeCamera);

</script>

</body>
</html>
