<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title></title>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
  <script src="http://localhost:8001/jquery.min.js"></script>
  <script src="http://localhost:8001/socket.io.js"></script>
  <script src="http://localhost:8001/qimessaging.js"></script>
  <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
  <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css" />
  <style type="text/css">
  #call { display: none }
  </style>
</head>
<body>

<script>
qim = new QiSession("http://localhost:8002");

n = 0;

function showServices(services) {
  n = services.length;
  for (var i = 0; i < services.length; i++)
  {
    qim.service(services[i]).done(showService);
  }
}

function createLOL(s, m, s3, s4)
{
  return function() {
    showCall(s, m, s3, s4)
  }
}

function showService(service) {
  var mobj = service.__mobj
  var tabname = $("<h3><b>" + mobj["name"] + "</b> [<i>" + mobj["doc"] + "</i>]</h3>")
  $("#accordion").append(tabname)

  var tab = $("<div/>")
  var list = $("<ul/>").appendTo(tab)
  for (var m in mobj.functions)
  {
    var f = mobj.functions[m]
    for (i = 0; i < f.signatures.length; i++)
    {
      var s3 = f.signatures[i][0]
      var s4 = f.signatures[i][1]

      $("<li>").html(f.signatures[i][0] + '::' + f.name
                       + '(' + f.signatures[i][1] + ') '
                       + '[<i>' + f.signatures[i][2] + '</i>]')
               .appendTo(list)
               .click(createLOL(service, f.name, s3, s4))
    }
  }
  $("#accordion").append(tab)

  if (--n == 0)
  {
    $("#accordion").accordion({
      heightStyle: "content"
    });
  }
}

function showError(s) {
  console.log(s);
}

function showResult(s) {
  $("#res").val(s)
}

function showCall(s, m, s3, s4) {
  $("#call").empty()
  $("#call").hide()

  $("<div/>").html(s3 + ' ' + s.__mobj["name"]+ "::" + m + "(" + s4 + ")").appendTo("#call")
  var c = $("<div/>").appendTo("#call")
  for (var i = 0 ; i < s4.length; i++)
  {
    var t = "";
    switch (s4[i])
    {
      case 'b': t = "bool"; break;
      case 'v': t = "void"; break;
      case 'C': case 'c': t = "int8"; break;
      case 'W': case 'w': t = "int16"; break;
      case 'I': case 'i': t = "int32"; break;
      case 'L': case 'l': t = "int64"; break;
      case 'f': t = "float"; break;
      case 'd': t = "double"; break;
      case 's': t = "string"; break;
      case 'm': t = "dynamic"; break;
      case 'r': t = "raw"; break;
      case '*': t = "pointer"; break;
      case 'o': t = "object"; break;
      case 'X': t = "unknown"; break;
      default: t = "arg";
    }
    $("<input />", { id: "args" + i, type: "input", placeholder: t }).appendTo(c)
  }
  $("<button/>", { id: "cbutton", type: "submit" }).html("call!").appendTo(c)
    .click(function() {
      var l = []
      for (i = 0; i < s4.length; i++)
      {
        l[i] = $("#args" + i).val()
      }
      s[m].apply(this, l).done(showResult).fail(showError);
    })
  $("<div/>").html("<input id='res' type='input'/>").appendTo(c)
  if (s3 == "v")
    $("#res").hide()

  $("#call").dialog();
  $("#call").fadeIn(400)
}

$(document).ready(function() {
  qim.services().done(showServices)
});
</script>

<div id="accordion"></div>

<div id="call"></div>
</body>
</html>
