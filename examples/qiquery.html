<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title></title>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
  <script src="http://localhost:8001/jquery.min.js"></script>
  <script src="http://localhost:8001/socket.io.js"></script>
  <script src="http://localhost:8001/qimessaging.js"></script>
  <script src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
  <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css" />
  <style type="text/css">
  #call { display: none }
  </style>
</head>
<body>

<script>
qim = new QiSession("http://localhost:8002");

n = 0;

function showServices(services) {
  n = services.length;
  for (var i = 0; i < services.length; i++)
  {
    qim.service(services[i][0]).done(showService);
  }
}

function createShowCall(s, m, sigret, sigarg)
{
  return function() {
    showCall(s, m, sigret, sigarg)
  }
}

function showService(service) {
  var mobj = service["__mobj"];
  var tabname = $("<h3><b>" + mobj[0] + "</b> [<i>" + mobj[1][3] + "</i>]</h3>")
  $("#accordion").append(tabname)

  var tab = $("<div/>")
  var list = $("<ul/>").appendTo(tab)
  for (var m in mobj[1][0])
  {
    var f = mobj[1][0][m];
    $("<li>").html(f[1] + '::' + f[2]
                     + f[3] + ' '
                     + '[<i>' + f[4] + '</i>]')
             .appendTo(list)
             .click(createShowCall(service, f[2], f[1], f[3]))
  }
  $("#accordion").append(tab)

  if (--n == 0)
  {
    $("#accordion").accordion({
      heightStyle: "content"
    });
  }
}

function showError(s) {
  console.log(s);
}

function showResult(s) {
  $("#res").val(s)
}

function showCall(s, m, sigret, sigarg) {
  $("#call").empty()
  $("#call").hide()

  $("<div/>").html(sigret + ' ' + s["__mobj"][0] + "::" + m + sigarg).appendTo("#call")
  var c = $("<div/>").appendTo("#call")
  for (var i = 1 ; i < sigarg.length - 1; i++)
  {
    var t = "";
    switch (sigarg[i])
    {
      case 'b': t = "bool"; break;
      case 'v': t = "void"; break;
      case 'C': case 'c': t = "int8"; break;
      case 'W': case 'w': t = "int16"; break;
      case 'I': case 'i': t = "int32"; break;
      case 'L': case 'l': t = "int64"; break;
      case 'f': t = "float"; break;
      case 'd': t = "double"; break;
      case 's': t = "string"; break;
      case 'm': t = "dynamic"; break;
      case 'r': t = "raw"; break;
      case '*': t = "pointer"; break;
      case 'o': t = "object"; break;
      case 'X': t = "unknown"; break;
      default: t = "arg";
    }
    $("<input />", { id: "args" + i, type: "input", placeholder: t }).appendTo(c)
  }
  $("<button/>", { id: "cbutton", type: "submit" }).html("call!").appendTo(c)
    .click(function() {
      var l = []
      for (i = 1; i < sigarg.length - 1; i++)
      {
        l[i - 1] = $("#args" + i).val()
      }
      s[m].apply(this, l).done(showResult).fail(showError);
    })
  $("<div/>").html("<input id='res' type='input'/>").appendTo(c)
  if (sigret == "v")
    $("#res").hide()

  $("#call").dialog();
  $("#call").fadeIn(400)
}

$(document).ready(function() {
  qim.services().done(showServices)
});
</script>

<div id="accordion"></div>

<div id="call"></div>
</body>
</html>
